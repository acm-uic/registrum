name: Docker CD - Branch

on:
  push:
    branches:
      - master
      - staging*

jobs:
  publish-app-images:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: docker build, push
      shell: pwsh
      run: |
        $branch="${GITHUB_REF#refs/heads/}"
        $rev="${GITHUB_SHA}".Substring(0,8)

        Write-Host branch: $branch
        Write-Host rev: $rev

        Write-Host ${{ secrets.GITHUB_TOKEN }} | docker login docker.pkg.github.com --username ${{ github.actor }} --password-stdin

        docker build -t registrum_base -f Base.Dockerfile .

        $projects=@("api", "banner", "banner-data", "client")
        projects=( api banner banner-data client )
        foreach($project in $projects) {
          Write-Host Working on $project ...
          docker build --target $project -t docker.pkg.github.com/${{ github.repository }}/$project:$rev .
          docker tag docker.pkg.github.com/${{ github.repository }}/$project:$rev docker.pkg.github.com/${{ github.repository }}/$project:$branch
          docker push docker.pkg.github.com/${{ github.repository }}/$project:$rev
          docker push docker.pkg.github.com/${{ github.repository }}/$project:$branch
        }
    - name: Trigger Hooks - master
      shell: pwsh
      if: github.ref == 'refs/heads/master'
      run: |
        Invoke-WebRequest -Method POST -Body @{} -Uri '${{ secrets.MASTER_HOOK }}'
    - name: Trigger Hooks - staging
      shell: pwsh
      if: github.ref == 'refs/heads/staging'
      run: |
        Invoke-WebRequest -Method POST -Body @{} -Uri '${{ secrets.STAGING_HOOK }}'
